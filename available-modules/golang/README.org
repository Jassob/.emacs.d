# -*- indent-tabs-mode: nil; -*-
#+TITLE: Go module
#+AUTHOR: Jassob
#+DATE: <2018-07-28>

* About this file
  This file contains the literate source of the Go module.

* Module
  This configuration sets up a Go mode where common-code minor mode is
  enabled together with a plethora of other useful stuff, such as
  linter and formatters etc.

  #+begin_src emacs-lisp :tangle module.el
    ;; Use package defaults for these packages
    (use-package go-guru :ensure t)
    (use-package company-go :ensure t)
    (use-package gotest :ensure t)
    (use-package go-eldoc :ensure t
      :init (add-hook 'go-mode-hook 'go-eldoc-setup))
    (use-package flycheck-golangci-lint :ensure t
      :init (setq flycheck-golangci-lint-fast t))

    (use-package go-mode
      :init
      (setq gofmt-command "goimports")
      (add-hook 'go-mode-hook 'common-code-mode)
      (add-hook 'go-mode-hook (lambda ()
                                (add-hook 'before-save-hook 'gofmt-before-save)
                                (append company-backends 'company-go)))
      (add-hook 'go-mode-hook #'flycheck-golangci-lint-setup)

      ;; Go Guru's keymap is on "C-c C-o"
      :bind (:map go-mode-map
                  ("C-c C-." . pop-tag-mark)
                  ("C-c C-," . go-guru-jump)
                  ("C-c C-r" . go-remove-unused-imports)
                  ("C-c C-g" . go-goto-imports)
                  ("C-c C-f" . gofmt)
                  ("C-c C-k" . godoc))

      :config
      (if (not (string-match "go" compile-command))
          (set (make-local-variable 'compile-command)
               "go build -v && go test -v && go vet")))
  #+end_src

  To make it easy to switch between the fast and slow check of
  ~golangci-lint~ I have this convenience function.

  #+begin_src emacs-lisp :tangle module.el
    (defun toggle-flycheck-golangci-lint-fast ()
      "Toggle between only using fast checkers and using all checkers for golangci-lint."
      (interactive)
      (if flycheck-golangci-lint-fast
          (setq flycheck-golangci-lint-fast nil)
        (setq flycheck-golangci-lint-fast t)))
  #+end_src
